<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±æ–‡ç©´åŸ‹ã‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°v2</title>
<style>
/* ====================================================== */
/* == ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ã‚¬ã‚¤ãƒ‰                               == */
/* == ã“ã“ã‹ã‚‰ä¸‹ã®å€¤ã‚’å¤‰æ›´ã™ã‚‹ã¨ãƒ‡ã‚¶ã‚¤ãƒ³ãŒå¤‰ã‚ã‚Šã¾ã™ == */
/* ====================================================== */

/* ===== å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« ===== */
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; /* ãƒ•ã‚©ãƒ³ãƒˆã®ç¨®é¡ */
  background-color: #f4f7f9; /* èƒŒæ™¯è‰² */
  color: #333; /* åŸºæœ¬ã®æ–‡å­—è‰² */
  margin: 0;
  padding: 20px; /* å¤–å´ã®ä½™ç™½ */
  display: flex;
  justify-content: center;
}

.container {
  background-color: #fff; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã®èƒŒæ™¯è‰² */
  padding: 30px; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã®å†…å´ã®ä½™ç™½ */
  border-radius: 12px; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã®è§’ã®ä¸¸ã¿ */
  box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* å½± */
  width: 100%;
  max-width: 700px; /* æœ€å¤§å¹… */
}

h2, h3 {
  color: #2c3e50; /* è¦‹å‡ºã—ã®æ–‡å­—è‰² */
  border-bottom: 2px solid #3498db; /* è¦‹å‡ºã—ã®ä¸‹ç·šã®è‰² */
  padding-bottom: 10px; /* è¦‹å‡ºã—ã¨ä¸‹ç·šã®é–“ã®ä½™ç™½ */
  margin-top: 0;
}

p {
  line-height: 1.6; /* æ®µè½ã®è¡Œã®é«˜ã• */
}

.hidden {
  display: none;
}

/* ===== å…¥åŠ›ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« ===== */
#inputArea p {
  background-color: #ecf0f1; /* èª¬æ˜æ–‡ã®èƒŒæ™¯è‰² */
  border-left: 4px solid #3498db; /* èª¬æ˜æ–‡ã®å·¦å´ã®ç·šã®è‰² */
  padding: 12px; /* èª¬æ˜æ–‡ã®å†…å´ã®ä½™ç™½ */
  border-radius: 4px;
}
textarea {
  width: 100%;
  height: 160px; /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã• */
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem; /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®æ–‡å­—ã‚µã‚¤ã‚º */
  box-sizing: border-box;
  transition: border-color 0.2s, box-shadow 0.2s;
}
textarea:focus {
  border-color: #3498db; /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®æ ç·šã®è‰² */
  box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å½±ã®è‰² */
  outline: none;
}

/* ===== ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« ===== */
button {
  padding: 10px 20px; /* ãƒœã‚¿ãƒ³ã®ä½™ç™½ */
  font-size: 1rem; /* ãƒœã‚¿ãƒ³ã®æ–‡å­—ã‚µã‚¤ã‚º */
  margin-top: 15px;
  border: none;
  border-radius: 6px;
  color: #fff; /* ãƒœã‚¿ãƒ³ã®æ–‡å­—è‰² */
  background-color: #3498db; /* é€šå¸¸ãƒœã‚¿ãƒ³ã®èƒŒæ™¯è‰² */
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s;
}
button:hover {
  background-color: #2980b9; /* é€šå¸¸ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰² */
}
button:active {
  transform: translateY(1px);
}
#retryBtn {
  background-color: #f39c12; /* ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ã®èƒŒæ™¯è‰² */
}
#retryBtn:hover {
  background-color: #e67e22; /* ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰² */
}
#restartBtn {
  background-color: #95a5a6; /* å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®èƒŒæ™¯è‰² */
  margin-left: 10px;
}
#restartBtn:hover {
  background-color: #7f8c8d; /* å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰² */
}

/* ===== ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« ===== */
.status {
  margin: 10px 0 20px 0;
  font-weight: bold;
  background-color: #eaf5fc; /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®èƒŒæ™¯è‰² */
  padding: 10px;
  border-radius: 6px;
  color: #2980b9; /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æ–‡å­—è‰² */
}
.question {
  margin: 20px 0;
  font-size: 1.4rem; /* å•é¡Œæ–‡ã®æ–‡å­—ã‚µã‚¤ã‚º */
  line-height: 1.8;
}
.jp {
  color: #555;
  margin-top: 10px;
  font-size: 1.2rem; /* æ—¥æœ¬èªè¨³ã®æ–‡å­—ã‚µã‚¤ã‚º */
}
input.blank {
  width: 120px; /* ç©´åŸ‹ã‚å…¥åŠ›æ¬„ã®å¹… */
  padding: 6px;
  margin: 0 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1.3rem; /* ç©´åŸ‹ã‚å…¥åŠ›æ¬„ã®æ–‡å­—ã‚µã‚¤ã‚º */
  text-align: center;
  transition: border-color 0.2s, box-shadow 0.2s;
}
input.blank:focus {
  border-color: #3498db;
  box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
  outline: none;
}

/* ===== ç­”ãˆåˆã‚ã›è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« ===== */
#answerContainer {
  margin-top: 25px;
  border-top: 2px dashed #bdc3c7;
  padding-top: 20px;
}
.answer-line {
  margin: 15px 0;
  font-size: 1.3rem; /* å›ç­”è¡¨ç¤ºã®æ–‡å­—ã‚µã‚¤ã‚º */
  padding: 10px;
  border-radius: 6px;
}
.answer-line strong {
    display: inline-block;
    width: 150px; /* ã€Œã‚ãªãŸã®å›ç­”ï¼šã€ãƒ©ãƒ™ãƒ«ã®å¹… */
}
#userAnswerLine { background-color: #f9f9f9; } /* ã‚ãªãŸã®å›ç­”è¡Œã®èƒŒæ™¯è‰² */
#correctAnswerLine { background-color: #eaf5fc; } /* æ­£ã—ã„å›ç­”è¡Œã®èƒŒæ™¯è‰² */

/* â˜… æ­£è§£ãƒ»ä¸æ­£è§£ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« â˜… */
.correct-text {
  color: #2ecc71; /* æ­£è§£ãƒ†ã‚­ã‚¹ãƒˆã®è‰² (ç·‘) */
  font-weight: bold;
}
.incorrect-text {
  color: #e74c3c; /* ä¸æ­£è§£ãƒ†ã‚­ã‚¹ãƒˆã®è‰² (èµ¤) */
  font-weight: bold; 
  text-decoration: line-through; 
  text-decoration-thickness: 2px;
  background-color: #fff0f0; /* â˜…ä¿®æ­£â˜… ä¸æ­£è§£ãƒ†ã‚­ã‚¹ãƒˆã®èƒŒæ™¯è‰² (è–„ã„èµ¤) */
  padding: 2px 5px;
  border-radius: 4px;
}
.highlight-answer {
  color: #c0392b; /* æ­£ã—ã„ç­”ãˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰² (æ¿ƒã„èµ¤) */
  font-weight: bold; 
  background-color: #eaf7ec; /* â˜…ä¿®æ­£â˜… æ­£ã—ã„ç­”ãˆã®èƒŒæ™¯è‰² (è–„ã„ç·‘) */
  padding: 2px 5px;
  border-radius: 4px;
}


/* ===== çµæœè¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« ===== */
#resultTitle {
  font-size: 1.5rem; /* çµæœã‚¿ã‚¤ãƒˆãƒ«ã®æ–‡å­—ã‚µã‚¤ã‚º */
  color: #fff;
  padding: 15px;
  border-radius: 6px;
  text-align: center;
}
#resultTitle.perfect {
  background: linear-gradient(45deg, #2ecc71, #27ae60); /* ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆæ™‚ã®èƒŒæ™¯è‰² */
}
#resultTitle.has-mistakes {
  background: linear-gradient(45deg, #f39c12, #e67e22); /* ãƒŸã‚¹ãŒã‚ã£ãŸæ™‚ã®èƒŒæ™¯è‰² */
}

.mistake {
  color: #c0392b; /* é–“é•ãˆãŸå•é¡Œãƒªã‚¹ãƒˆã®æ–‡å­—è‰² */
  background-color: #fff6f6; /* é–“é•ãˆãŸå•é¡Œãƒªã‚¹ãƒˆã®èƒŒæ™¯è‰² */
  padding: 15px;
  border-radius: 6px;
  border: 1px solid #f5c6cb;
  margin-bottom: 12px;
  font-size: 1.1rem; /* é–“é•ãˆãŸå•é¡Œãƒªã‚¹ãƒˆã®æ–‡å­—ã‚µã‚¤ã‚º */
  line-height: 1.7;
}
.mistake .jp {
  color: #777;
  font-size: 0.95rem;
  margin-top: 5px;
}
</style>
</head>
<body>

<div class="container">
  <h2>è‹±æ–‡ç©´åŸ‹ã‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>

  <!-- ======= â‘  å…¥åŠ›ç”»é¢ ======= -->
  <div id="inputArea">
    <p>ä»¥ä¸‹ã®æ›¸å¼ã§è‹±æ–‡ã‚’å…¥åŠ›ã—ã€é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
    è‹±æ–‡ä¸­ã§ç©´åŸ‹ã‚å€™è£œã«ã—ãŸã„èªå¥ã‚’ < > ã§å›²ã¿ã€æœ«å°¾ã«ã€Œ@æ—¥æœ¬èªè¨³ã€ã‚’ä»˜ä¸ã€æ–‡ã”ã¨ã«æ”¹è¡Œã—ã¾ã™ã€‚</p>
    <p>ä¾‹)<br>
    I <often eat> breakfast <at> seven.@ç§ã¯æ™®æ®µ7æ™‚ã«æœé£Ÿã‚’é£Ÿã¹ã‚‹ã€‚<br>
    We <will meet> you <in> the lobby.@ãƒ­ãƒ“ãƒ¼ã§ä¼šã„ã¾ã—ã‚‡ã†ã€‚</p>

    <textarea id="srcText" placeholder="ã“ã“ã«è‹±æ–‡ã‚’å…¥åŠ›..."></textarea><br>
    <button id="startBtn">é–‹å§‹</button>
  </div>

  <!-- ======= â‘¡ å•é¡Œå‡ºé¡Œç”»é¢ ======= -->
  <div id="quizArea" class="hidden">
    <div class="status" id="statusLine"></div>
    
    <!-- å•é¡Œå…¥åŠ›éƒ¨åˆ† -->
    <div id="questionContainer">
      <div class="question" id="questionBox"></div>
      <button id="checkBtn">è§£ç­”</button>
    </div>

    <!-- ç­”ãˆåˆã‚ã›è¡¨ç¤ºéƒ¨åˆ† -->
    <div id="answerContainer" class="hidden">
      <div id="userAnswerLine" class="answer-line"></div>
      <div id="correctAnswerLine" class="answer-line"></div>
      <button id="nextBtn">æ¬¡ã¸é€²ã‚€</button>
    </div>
  </div>


  <!-- ======= â‘¢ çµæœè¡¨ç¤ºç”»é¢ ======= -->
  <div id="resultArea" class="hidden">
    <h3 id="resultTitle"></h3>
    <div id="mistakeList"></div>
    <button id="retryBtn">ãƒªãƒˆãƒ©ã‚¤</button>
    <button id="restartBtn">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
  </div>
</div>

<script>
/* ======  ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿æŒç”¨  ====== */
let allSentences = [];
let currentRound = [];
let currentIdx = 0;
let correctCount = 0;
let mistakeArray = [];

/* ====== sentence ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­èº« ======
{
  engRaw : "I <often eat> breakfast <at> seven.",
  jpn    : "ç§ã¯æ™®æ®µ7æ™‚ã«æœé£Ÿã‚’é£Ÿã¹ã‚‹ã€‚",
  blanks : [ {text:"often eat"}, {text:"at"} ],
  hideIdx: [0],
  isMistakenOnce: false,
}
========================================= */

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}
/* ====================================== */

/* ========== â‘  å…¥åŠ›â†’é…åˆ—åŒ– ========== */
document.getElementById('startBtn').addEventListener('click', ()=>{
  const raw = document.getElementById('srcText').value.trim();
  if(!raw){alert("è‹±æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  
  allSentences = [];
  raw.split(/\n+/).forEach(line=>{
    const [eng, jpn=""] = line.split("@");
    if(!eng) return;
    const blanks = [];
    const regex = /<([^>]+)>/g;
    let m;
    while((m=regex.exec(eng))!==null){
      blanks.push({text:m[1]});
    }
    if(blanks.length===0) return;
    
    allSentences.push({
      engRaw: eng.trim(),
      jpn   : jpn.trim(),
      blanks: blanks
    });
  });
  
  if(allSentences.length===0){ alert("ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«åˆè‡´ã™ã‚‹æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return;}
  
  startRound(allSentences);
  document.getElementById('inputArea').classList.add('hidden');
});

/* ========== ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹é–¢æ•° ========== */
function startRound(sentenceArray){
  currentRound = sentenceArray.map(src=>{
    const obj = JSON.parse(JSON.stringify(src));
    const n = obj.blanks.length;
    const need = Math.ceil(n*0.7);
    const idxArr = [...Array(n).keys()];
    shuffle(idxArr);
    obj.hideIdx = idxArr.slice(0,need);
    obj.isMistakenOnce = false;
    return obj;
  });
  
  shuffle(currentRound);
  currentIdx = 0;
  correctCount = 0;
  mistakeArray = [];
  
  document.querySelector('.container').classList.remove('hidden');
  document.getElementById('inputArea').classList.add('hidden');
  document.getElementById('quizArea').classList.remove('hidden');
  document.getElementById('resultArea').classList.add('hidden');
  showQuestion();
}

/* ========== å•é¡Œè¡¨ç¤º ========== */
function showQuestion(){
  document.getElementById('questionContainer').classList.remove('hidden');
  document.getElementById('answerContainer').classList.add('hidden');

  const s = currentRound[currentIdx];
  const parts = [];
  let blankNo = 0;
  s.engRaw.split(/(<[^>]+>)/).forEach(part=>{
    if(/^<[^>]+>$/.test(part)){
      const pure = part.slice(1,-1);
      if( s.hideIdx.includes(blankNo) ){
        parts.push(`<input type="text" class="blank" data-ans="${pure}">`);
      }else{
        parts.push(pure);
      }
      blankNo++;
    }else{
      parts.push(part);
    }
  });
  const questionHTML = `<div>${parts.join('')}</div><div class="jp">${s.jpn}</div>`;
  document.getElementById('questionBox').innerHTML = questionHTML;
  document.querySelector('#questionBox input.blank')?.focus(); // æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  
  updateStatus();
}

/* ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ========== */
function updateStatus(){
  const rest = currentRound.length - currentIdx;
  document.getElementById('statusLine').textContent = 
    `æ®‹ã‚Š ${rest} å• | æ­£è§£ ${correctCount} å•`;
}

/* ========== è§£ç­”ãƒã‚§ãƒƒã‚¯ ========== */
document.getElementById('checkBtn').addEventListener('click', ()=>{
  const s = currentRound[currentIdx];
  const inputs = document.querySelectorAll('#questionBox input.blank');
  
  let allOk = true;
  const userAnswerParts = [];
  const correctAnswerParts = [];
  let blankNo = 0;
  let inputIdx = 0;

  s.engRaw.split(/(<[^>]+>)/).forEach(part => {
    if(/^<[^>]+>$/.test(part)){ // ãƒ–ãƒ©ãƒ³ã‚¯å€™è£œ <foo>
      const correctText = part.slice(1, -1);
      
      if (s.hideIdx.includes(blankNo)) { // ã“ã®ãƒ–ãƒ©ãƒ³ã‚¯ã¯å•é¡Œã ã£ãŸ
        const userText = inputs[inputIdx].value.trim();
        const userTextForDisplay = userText || '(ç„¡å›ç­”)';
        
        if (userText.toLowerCase() === correctText.toLowerCase()) {
          userAnswerParts.push(`<span class="correct-text">${userTextForDisplay}</span>`);
          correctAnswerParts.push(`<span class="correct-text">${correctText}</span>`);
        } else {
          allOk = false;
          userAnswerParts.push(`<span class="incorrect-text">${userTextForDisplay}</span>`);
          correctAnswerParts.push(`<span class="highlight-answer">${correctText}</span>`);
        }
        inputIdx++;
      } else { // å•é¡Œã§ã¯ãªã‹ã£ãŸãƒ–ãƒ©ãƒ³ã‚¯
        userAnswerParts.push(correctText);
        correctAnswerParts.push(correctText);
      }
      blankNo++;
    } else { // é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆ
      userAnswerParts.push(part);
      correctAnswerParts.push(part);
    }
  });

  if (!allOk) {
    s.isMistakenOnce = true;
  }
  
  document.getElementById('userAnswerLine').innerHTML = `<strong>ã‚ãªãŸã®å›ç­”ï¼š</strong> ${userAnswerParts.join(' ')}`;
  document.getElementById('correctAnswerLine').innerHTML = `<strong>æ­£ã—ã„å›ç­”ï¼š</strong> ${correctAnswerParts.join(' ')}`;
  
  document.getElementById('questionContainer').classList.add('hidden');
  document.getElementById('answerContainer').classList.remove('hidden');
  document.getElementById('nextBtn').focus();
});


/* ========== æ¬¡ã®å•é¡Œã¸ ========== */
document.getElementById('nextBtn').addEventListener('click', ()=>{
  const s = currentRound[currentIdx];
  if (s.isMistakenOnce) {
    mistakeArray.push(s);
  } else {
    correctCount++;
  }
  
  currentIdx++;
  if (currentIdx >= currentRound.length) {
    showResult();
  } else {
    showQuestion();
  }
});

/* ========== çµæœè¡¨ç¤º ========== */
function showResult(){
  document.getElementById('quizArea').classList.add('hidden');
  const rArea = document.getElementById('resultArea');
  rArea.classList.remove('hidden');
  
  const resultTitle = document.getElementById('resultTitle');
  if (mistakeArray.length === 0) {
    resultTitle.textContent = "ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ğŸ‰";
    resultTitle.className = "perfect";
  } else {
    resultTitle.textContent = `çµ‚äº†ï¼š${mistakeArray.length} æ–‡ã§ãƒŸã‚¹ãŒã‚ã‚Šã¾ã—ãŸ`;
    resultTitle.className = "has-mistakes";
  }
  
  const listDiv = document.getElementById('mistakeList');
  listDiv.innerHTML = "";
  if(mistakeArray.length){
    mistakeArray.forEach((s,i)=>{
      let idx=0;
      const fixed = s.engRaw.replace(/<([^>]+)>/g,(m,p1)=>{
        const disp = s.hideIdx.includes(idx) ? `<strong>(${p1})</strong>` : p1;
        idx++;
        return disp;
      });
      listDiv.innerHTML += `<div class="mistake">${i+1}. ${fixed}<div class="jp">${s.jpn}</div></div>`;
    });
  }
  
  document.getElementById('retryBtn').style.display =
       mistakeArray.length ? "inline-block" : "none";
}

/* ========== ãƒªãƒˆãƒ©ã‚¤ / å†ã‚¹ã‚¿ãƒ¼ãƒˆ ========== */
document.getElementById('retryBtn').addEventListener('click', ()=>{
  if(!mistakeArray.length) return;
  startRound(mistakeArray);
});
document.getElementById('restartBtn').addEventListener('click', ()=>{
  document.getElementById('inputArea').classList.remove('hidden');
  document.getElementById('quizArea').classList.add('hidden');
  document.getElementById('resultArea').classList.add('hidden');
  document.getElementById('srcText').value = ''; // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
  document.getElementById('srcText').focus();
});
</script>
</body>
</html>
