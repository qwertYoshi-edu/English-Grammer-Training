<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±æ–‡ç©´åŸ‹ã‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°v8</title>
<style>
/* ====================================================== */
/* == ãƒ‡ã‚¶ã‚¤ãƒ³ãƒªãƒ•ã‚¡ã‚¤ãƒ³                               == */
/* ====================================================== */

:root {
  /* Colors */
  --primary-color: #3498db;
  --primary-hover-color: #2980b9;
  --secondary-color: #f39c12;
  --secondary-hover-color: #e67e22;
  --danger-color: #e74c3c;
  --danger-hover-color: #c0392b;
  --danger-bg-color: #fff0f0;
  --warning-color: #d35400;
  --warning-hover-color: #e67e22;
  --success-color: #2ecc71;
  --success-hover-color: #27ae60;
  --neutral-color: #95a5a6;
  --neutral-hover-color: #7f8c8d;
  --info-color: #16a085;
  --info-hover-color: #1abc9c;
  
  --text-color: #2c3e50;
  --text-muted-color: #555;
  --bg-color: #f0f4f8;
  --panel-bg-color: #ffffff;
  --border-color: #dce4ec;
  --panel-shadow: 0 2px 8px rgba(0,0,0,0.06);

  /* Spacing */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 12px;
  --spacing-lg: 16px;

  /* Typography */
  --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --font-size-base: 1rem;
  --font-size-md: 0.9rem;
  --font-size-sm: 0.8rem;
  --font-size-xs: 0.75rem;

  /* Borders */
  --border-radius: 4px;

  /* Components */
  --blank-input-width: 70px;
}

/* ===== å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« ===== */
body {
  font-family: var(--font-family);
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 0;
  padding: var(--spacing-sm);
  font-size: var(--font-size-base);
  overflow: hidden; /* â˜…å¤‰æ›´â˜… ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
}

.main-wrapper {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: var(--spacing-sm);
    width: 100%;
    max-width: 1100px;
    margin: 0 auto;
}

/* ===== ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« ===== */
#sideMistakePanel {
    width: 360px;
    background-color: var(--panel-bg-color);
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
    box-shadow: var(--panel-shadow);
    position: sticky;
    top: var(--spacing-sm);
    flex-shrink: 0;
    /* â˜…å¤‰æ›´â˜… é«˜ã•ã‚’ç”»é¢ã«åˆã‚ã›ã‚‹ */
    height: calc(100vh - 2 * var(--spacing-sm));
    display: flex;
    flex-direction: column;
}
#sideMistakePanel h3 {
    margin: 0 0 var(--spacing-md) 0;
    padding-bottom: var(--spacing-md);
    font-size: 1.1rem;
    color: var(--danger-color);
    border-bottom: 2px solid var(--secondary-color);
    flex-shrink: 0;
}
#sideMistakeList {
    overflow-y: auto;
    padding-right: var(--spacing-xs);
}
.side-mistake-item {
    margin-bottom: var(--spacing-sm);
    padding-bottom: var(--spacing-sm);
    border-bottom: 1px dashed var(--border-color);
    font-size: var(--font-size-xs);
    line-height: 1.5;
    word-break: break-all;
}
.side-mistake-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}
.side-user-answer::before {
    content: "èª¤ï¼š";
    color: var(--danger-color);
    font-weight: bold;
}
.side-correct-answer::before {
    content: "æ­£ï¼š";
    color: var(--success-color);
    font-weight: bold;
}

/* ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ ===== */
.container {
  background-color: var(--panel-bg-color);
  padding: var(--spacing-lg);
  border-radius: var(--border-radius);
  box-shadow: var(--panel-shadow);
  width: 100%;
  max-width: 700px;
  /* â˜…è¿½åŠ â˜… é«˜ã•ã‚’ç”»é¢ã«åˆã‚ã›ã€å†…éƒ¨ã‚’Flexboxã§åˆ¶å¾¡ */
  height: calc(100vh - 2 * var(--spacing-sm));
  box-sizing: border-box; /* paddingã¨borderã‚’é«˜ã•ã«å«ã‚ã‚‹ */
  display: flex;
  flex-direction: column;
}

/* â˜…è¿½åŠ â˜… ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
.main-content-area {
    flex-grow: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’ã™ã¹ã¦ä½¿ç”¨ */
    overflow-y: auto; /* å†…å®¹ãŒã¯ã¿å‡ºã—ãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    padding-right: var(--spacing-sm); /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¨ã®ä½™ç™½ */
    margin-right: -5px;
}


h2, h3 {
  color: var(--text-color);
  border-bottom: 2px solid var(--primary-color);
  padding-bottom: var(--spacing-sm);
  margin: 0 0 var(--spacing-lg) 0;
  flex-shrink: 0; /* â˜…è¿½åŠ â˜… ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ç¸®ã¾ãªã„ã‚ˆã†ã« */
}
h2 { font-size: 1.4rem; }
h3 { font-size: 1.2rem; }

p {
  line-height: 1.7;
  margin: 0 0 var(--spacing-md) 0;
}
p:last-child { margin-bottom: 0; }

.hidden {
  display: none;
}

/* ===== å…¥åŠ›ã‚¨ãƒªã‚¢ ===== */
#inputArea p {
  background-color: #ecf0f1;
  border-left: 4px solid var(--primary-color);
  padding: var(--spacing-sm);
  border-radius: var(--border-radius);
  font-size: var(--font-size-md);
}
textarea {
  width: 100%;
  height: 160px;
  padding: var(--spacing-sm);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  font-size: var(--font-size-md);
  box-sizing: border-box;
  transition: border-color 0.2s, box-shadow 0.2s;
}
textarea:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
  outline: none;
}

/* ===== ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« ===== */
button {
  padding: var(--spacing-sm) var(--spacing-lg);
  font-size: var(--font-size-md);
  margin-top: var(--spacing-sm);
  border: none;
  border-radius: var(--border-radius);
  color: #fff;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
  font-weight: 500;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
button:active {
  transform: translateY(0);
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* ===== å„ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« ===== */
#startBtn, #checkBtn, #nextBtn { background-color: var(--primary-color); }
#startBtn:hover, #checkBtn:hover, #nextBtn:hover { background-color: var(--primary-hover-color); }

#retryBtn { background-color: var(--secondary-color); }
#retryBtn:hover { background-color: var(--secondary-hover-color); }

#restartBtn { background-color: var(--neutral-color); margin-left: var(--spacing-sm); }
#restartBtn:hover { background-color: var(--neutral-hover-color); }

#reviewMistakesBtn { background-color: var(--info-color); margin-left: var(--spacing-sm); }
#reviewMistakesBtn:hover { background-color: var(--info-hover-color); }
#reviewMistakesBtn.in-review { background-color: var(--danger-color); }
#reviewMistakesBtn.in-review:hover { background-color: var(--danger-hover-color); }

#instantRetryBtn { background-color: var(--warning-color); margin-left: var(--spacing-sm); }
#instantRetryBtn:hover { background-color: var(--warning-hover-color); }


/* ===== ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢ ===== */
.status {
  margin-bottom: var(--spacing-lg);
  font-weight: bold;
  background-color: #eaf5fc;
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--border-radius);
  color: var(--primary-hover-color);
  font-size: var(--font-size-md);
}
.question {
  margin: var(--spacing-lg) 0;
  font-size: 1.05rem;
  line-height: 2;
}
.jp {
  color: var(--text-muted-color);
  margin-top: var(--spacing-sm);
  font-size: var(--font-size-sm);
}

input.blank {
  width: var(--blank-input-width);
  padding: var(--spacing-xs);
  margin: 0 var(--spacing-xs);
  border: 1px solid var(--border-color);
  border-bottom-width: 2px;
  border-radius: var(--border-radius);
  font-size: 1rem;
  text-align: center;
  transition: border-color 0.2s, box-shadow 0.2s;
  vertical-align: baseline;
}
input.blank:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
  outline: none;
}

/* ===== ç­”ãˆåˆã‚ã›è¡¨ç¤º ===== */
#answerContainer {
  margin-top: var(--spacing-lg);
  border-top: 2px dashed var(--border-color);
  padding-top: var(--spacing-md);
}
.answer-line {
  margin: var(--spacing-sm) 0;
  font-size: var(--font-size-md);
  padding: var(--spacing-sm);
  border-radius: var(--border-radius);
}
.answer-line strong {
    display: inline-block;
    width: 120px;
    font-weight: 600;
}
#userAnswerLine { background-color: #f8f9fa; }
#correctAnswerLine { background-color: #eaf5fc; }

/* æ­£è§£ãƒ»ä¸æ­£è§£ãƒ†ã‚­ã‚¹ãƒˆ */
.correct-text {
  color: var(--success-color);
  font-weight: bold;
}
.incorrect-text {
  color: var(--danger-color);
  font-weight: bold; 
  text-decoration: line-through; 
  text-decoration-thickness: 2px;
  background-color: var(--danger-bg-color);
  padding: 2px 4px;
  border-radius: var(--border-radius);
}
.highlight-answer {
  color: #c0392b;
  font-weight: bold; 
  background-color: #eaf7ec;
  padding: 2px 4px;
  border-radius: var(--border-radius);
}


/* ===== çµæœè¡¨ç¤º ===== */
#resultTitle {
  font-size: 1.2rem;
  color: #fff;
  padding: var(--spacing-lg);
  border-radius: var(--border-radius);
  text-align: center;
  margin-bottom: var(--spacing-lg);
}
#resultTitle.perfect {
  background: linear-gradient(45deg, var(--success-color), var(--success-hover-color));
}
#resultTitle.has-mistakes {
  background: linear-gradient(45deg, var(--secondary-color), var(--warning-color));
}

.mistake {
  background-color: #fff6f6;
  padding: var(--spacing-md);
  border-radius: var(--border-radius);
  border: 1px solid #f5c6cb;
  margin-bottom: var(--spacing-md);
  font-size: var(--font-size-md);
  line-height: 1.7;
}
.mistake .jp {
  color: #777;
  font-size: var(--font-size-xs);
  margin-top: var(--spacing-xs);
}
</style>
</head>
<body>

<div class="main-wrapper">

  <div id="sideMistakePanel" class="hidden">
    <h3>é–“é•ã„ãƒªã‚¹ãƒˆ</h3>
    <div id="sideMistakeList"></div>
  </div>

  <div class="container">
    <h2>è‹±æ–‡ç©´åŸ‹ã‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>

    <!-- â˜…è¿½åŠ â˜… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼ -->
    <div class="main-content-area">
      <!-- ======= â‘  å…¥åŠ›ç”»é¢ ======= -->
      <div id="inputArea">
        <p>ä»¥ä¸‹ã®æ›¸å¼ã§è‹±æ–‡ã‚’å…¥åŠ›ã—ã€é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
        è‹±æ–‡ä¸­ã§ç©´åŸ‹ã‚å€™è£œã«ã—ãŸã„èªå¥ã‚’ < > ã§å›²ã¿ã€æœ«å°¾ã«ã€Œ@æ—¥æœ¬èªè¨³ã€ã‚’ä»˜ä¸ã—ã¾ã™ã€‚<b>å•é¡Œã¨å•é¡Œã®é–“ã¯ # ã§åŒºåˆ‡ã£ã¦ãã ã•ã„ã€‚</b></p>
        <p>ä¾‹)<br>
        <!-- â˜…å¤‰æ›´â˜… ä¾‹æ–‡ã‚’ä¿®æ­£ -->
        I &lt;often&gt; &lt;eat&gt; breakfast &lt;at&gt; seven.@ç§ã¯æ™®æ®µ7æ™‚ã«æœé£Ÿã‚’é£Ÿã¹ã‚‹ã€‚#<br>
        We &lt;will&gt; &lt;meet&gt; you &lt;in&gt; the lobby.@ãƒ­ãƒ“ãƒ¼ã§ä¼šã„ã¾ã—ã‚‡ã†ã€‚</p>

        <textarea id="srcText" placeholder="ã“ã“ã«è‹±æ–‡ã‚’å…¥åŠ›..."></textarea><br>
        <button id="startBtn">é–‹å§‹</button>
      </div>

      <!-- ======= â‘¡ å•é¡Œå‡ºé¡Œç”»é¢ ======= -->
      <div id="quizArea" class="hidden">
        <div class="status" id="statusLine"></div>
        
        <div id="questionContainer">
          <div class="question" id="questionBox"></div>
          <button id="checkBtn">è§£ç­”</button>
          <button id="reviewMistakesBtn" class="hidden">é–“é•ã„ã‚’å¾©ç¿’</button>
        </div>

        <div id="answerContainer" class="hidden">
          <div id="userAnswerLine" class="answer-line"></div>
          <div id="correctAnswerLine" class="answer-line"></div>
          <button id="nextBtn">æ¬¡ã¸é€²ã‚€</button>
          <button id="instantRetryBtn" class="hidden">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
        </div>
      </div>


      <!-- ======= â‘¢ çµæœè¡¨ç¤ºç”»é¢ ======= -->
      <div id="resultArea" class="hidden">
        <h3 id="resultTitle"></h3>
        <div id="mistakeList"></div>
        <button id="retryBtn">ãƒªãƒˆãƒ©ã‚¤</button>
        <button id="restartBtn">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
      </div>
    </div> <!-- â˜…è¿½åŠ â˜… ãƒ©ãƒƒãƒ‘ãƒ¼ã®é–‰ã˜ã‚¿ã‚° -->
  </div>

</div>


<script>
/* ======  ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿æŒç”¨  ====== */
let allSentences = [];
let currentRound = [];
let currentIdx = 0;
let correctCount = 0;
let mistakeArray = [];
let backupState = null;
let isReviewing = false;

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}
/* ====================================== */

/* ========== â‘  å…¥åŠ›â†’é…åˆ—åŒ– ========== */
document.getElementById('startBtn').addEventListener('click', ()=>{
  const raw = document.getElementById('srcText').value.trim();
  if(!raw){alert("è‹±æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  
  allSentences = [];
  
  raw.split('#').forEach(problemBlock => {
    const block = problemBlock.trim();
    if (!block) return;

    const [eng, jpn=""] = block.split("@");
    if(!eng) return;

    const blanks = [];
    const regex = /<([^>]+)>/g;
    let m;
    while((m=regex.exec(eng))!==null){
      blanks.push({text:m[1]});
    }
    if(blanks.length===0) return;
    
    allSentences.push({
      engRaw: eng.trim(),
      jpn   : jpn.trim(),
      blanks: blanks
    });
  });
  
  if(allSentences.length===0){ alert("ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«åˆè‡´ã™ã‚‹æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return;}
  
  startRound(allSentences);
  document.getElementById('inputArea').classList.add('hidden');
});

/* ========== ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹é–¢æ•° ========== */
function startRound(sentenceArray){
  currentRound = sentenceArray.map(src=>{
    const obj = JSON.parse(JSON.stringify(src));
    const n = obj.blanks.length;
    const need = Math.ceil(n*0.7);
    const idxArr = [...Array(n).keys()];
    shuffle(idxArr);
    obj.hideIdx = idxArr.slice(0,need);
    obj.isMistakenOnce = false;
    delete obj.userAnswerHTML;
    delete obj.correctAnswerHTML;
    return obj;
  });
  
  shuffle(currentRound);
  currentIdx = 0;
  correctCount = 0;
  mistakeArray = [];
  isReviewing = false;
  backupState = null;
  
  document.querySelector('.container').classList.remove('hidden');
  document.getElementById('inputArea').classList.add('hidden');
  document.getElementById('quizArea').classList.remove('hidden');
  document.getElementById('resultArea').classList.add('hidden');

  document.getElementById('sideMistakePanel').classList.remove('hidden');
  updateSideMistakePanel();

  document.getElementById('reviewMistakesBtn').classList.add('hidden');
  document.getElementById('instantRetryBtn').classList.add('hidden');

  showQuestion();
}

/* ========== å•é¡Œè¡¨ç¤º ========== */
function showQuestion(){
  document.getElementById('questionContainer').classList.remove('hidden');
  document.getElementById('answerContainer').classList.add('hidden');

  const s = currentRound[currentIdx];
  const parts = [];
  let blankNo = 0;
  s.engRaw.split(/(<[^>]+>)/).forEach(part=>{
    if(/^<[^>]+>$/.test(part)){
      const pure = part.slice(1,-1);
      if( s.hideIdx.includes(blankNo) ){
        parts.push(`<input type="text" class="blank" data-ans="${pure}">`);
      }else{
        parts.push(pure);
      }
      blankNo++;
    }else{
      parts.push(part);
    }
  });
  const questionHTML = `<div>${parts.join('')}</div><div class="jp">${s.jpn}</div>`;
  document.getElementById('questionBox').innerHTML = questionHTML;
  document.querySelector('#questionBox input.blank')?.focus();
  
  updateStatus();
}

/* ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ========== */
function updateStatus(){
  const rest = currentRound.length - currentIdx;
  if (isReviewing) {
    document.getElementById('statusLine').textContent = 
      `å¾©ç¿’ä¸­ - æ®‹ã‚Š ${rest} å•`;
  } else {
    document.getElementById('statusLine').textContent = 
      `æ®‹ã‚Š ${rest} å• | æ­£è§£ ${correctCount} å•`;
  }
}

/* ========== è§£ç­”ãƒã‚§ãƒƒã‚¯ ========== */
document.getElementById('checkBtn').addEventListener('click', ()=>{
  const s = currentRound[currentIdx];
  const inputs = document.querySelectorAll('#questionBox input.blank');
  
  let allOk = true;
  const userAnswerParts = [];
  const correctAnswerParts = [];
  let blankNo = 0;
  let inputIdx = 0;

  s.engRaw.split(/(<[^>]+>)/).forEach(part => {
    if(/^<[^>]+>$/.test(part)){
      const correctText = part.slice(1, -1);
      
      if (s.hideIdx.includes(blankNo)) {
        const userText = inputs[inputIdx].value.trim();
        const userTextForDisplay = userText || '(ç„¡å›ç­”)';
        
        if (userText.toLowerCase() === correctText.toLowerCase()) {
          userAnswerParts.push(`<span class="correct-text">${userTextForDisplay}</span>`);
          correctAnswerParts.push(`<span class="correct-text">${correctText}</span>`);
        } else {
          allOk = false;
          userAnswerParts.push(`<span class="incorrect-text">${userTextForDisplay}</span>`);
          correctAnswerParts.push(`<span class="highlight-answer">${correctText}</span>`);
        }
        inputIdx++;
      } else {
        userAnswerParts.push(correctText);
        correctAnswerParts.push(correctText);
      }
      blankNo++;
    } else {
      userAnswerParts.push(part);
      correctAnswerParts.push(part);
    }
  });

  if (!allOk) {
    s.isMistakenOnce = true;
    s.userAnswerHTML = userAnswerParts.join(' ');
    s.correctAnswerHTML = correctAnswerParts.join(' ');
    
    if (!isReviewing) {
        if (!mistakeArray.find(item => item.engRaw === s.engRaw)) {
            mistakeArray.push(s);
        }
        updateSideMistakePanel();
    }
  } else {
      s.isMistakenOnce = false;
  }
  
  document.getElementById('userAnswerLine').innerHTML = `<strong>ã‚ãªãŸã®å›ç­”ï¼š</strong> ${userAnswerParts.join(' ')}`;
  document.getElementById('correctAnswerLine').innerHTML = `<strong>æ­£ã—ã„å›ç­”ï¼š</strong> ${correctAnswerParts.join(' ')}`;
  
  document.getElementById('instantRetryBtn').classList.toggle('hidden', allOk);
  
  document.getElementById('questionContainer').classList.add('hidden');
  document.getElementById('answerContainer').classList.remove('hidden');
  document.getElementById('nextBtn').focus();
});


/* ========== æ¬¡ã®å•é¡Œã¸ ========== */
document.getElementById('nextBtn').addEventListener('click', ()=>{
  const s = currentRound[currentIdx];

  if (isReviewing) {
    if (!s.isMistakenOnce) {
        const idx = mistakeArray.findIndex(item => item.engRaw === s.engRaw);
        if (idx !== -1) {
            mistakeArray.splice(idx, 1);
        }
        updateSideMistakePanel();
    }
  } else {
    if (!s.isMistakenOnce) {
        correctCount++;
    }
  }
  
  currentIdx++;
  if (currentIdx >= currentRound.length) {
      if (isReviewing) {
          alert("å¾©ç¿’ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å…ƒã®ã‚¯ã‚¤ã‚ºã«æˆ»ã‚Šã¾ã™ã€‚");
          restoreQuizState();
          showQuestion();
      } else {
          showResult();
      }
  } else {
      showQuestion();
  }
});

/* ========== ã‚µã‚¤ãƒ‰ã®é–“é•ã„ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•° ========== */
function updateSideMistakePanel() {
    const listDiv = document.getElementById('sideMistakeList');
    const reviewBtn = document.getElementById('reviewMistakesBtn');
    
    if (mistakeArray.length > 0) {
        let html = '';
        mistakeArray.forEach(s => {
            if (s.userAnswerHTML && s.correctAnswerHTML) {
                let userHTML = s.userAnswerHTML;
                let correctHTML = s.correctAnswerHTML;

                if (isReviewing) {
                    const replacer = (match, openTag, content, closeTag) => {
                        if (content === '(ç„¡å›ç­”)') return match;
                        return openTag + '*'.repeat(content.length) + closeTag;
                    };
                    const regex = /(<span class="(?:incorrect-text|highlight-answer|correct-text)">)([^<]+)(<\/span>)/g;
                    userHTML = userHTML.replace(regex, replacer);
                    correctHTML = correctHTML.replace(regex, replacer);
                }

                html += `
                    <div class="side-mistake-item">
                        <div class="side-user-answer">${userHTML}</div>
                        <div class="side-correct-answer">${correctHTML}</div>
                    </div>
                `;
            }
        });
        listDiv.innerHTML = html;
        if(!isReviewing) reviewBtn.classList.remove('hidden');
    } else {
        listDiv.innerHTML = `<p style="color:#999; font-size:0.8rem; padding:10px;">ã¾ã é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
        reviewBtn.classList.add('hidden');
    }
}


/* ========== çµæœè¡¨ç¤º ========== */
function showResult(){
  document.getElementById('quizArea').classList.add('hidden');
  const rArea = document.getElementById('resultArea');
  rArea.classList.remove('hidden');
  
  document.getElementById('sideMistakePanel').classList.add('hidden');

  const resultTitle = document.getElementById('resultTitle');
  if (mistakeArray.length === 0) {
    resultTitle.textContent = "ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ğŸ‰";
    resultTitle.className = "perfect";
  } else {
    resultTitle.textContent = `çµ‚äº†ï¼š${mistakeArray.length} æ–‡ã§ãƒŸã‚¹ãŒã‚ã‚Šã¾ã—ãŸ`;
    resultTitle.className = "has-mistakes";
  }
  
  const listDiv = document.getElementById('mistakeList');
  listDiv.innerHTML = "";
  if(mistakeArray.length){
    mistakeArray.forEach((s,i)=>{
      let idx=0;
      const fixed = s.engRaw.replace(/<([^>]+)>/g,(m,p1)=>{
        const disp = s.hideIdx.includes(idx) ? `<strong>(${p1})</strong>` : p1;
        idx++;
        return disp;
      });
      listDiv.innerHTML += `<div class="mistake">${i+1}. ${fixed}<div class="jp">${s.jpn}</div></div>`;
    });
  }
  
  document.getElementById('retryBtn').style.display =
       mistakeArray.length ? "inline-block" : "none";
}

/* ========== ãƒªãƒˆãƒ©ã‚¤ / å†ã‚¹ã‚¿ãƒ¼ãƒˆ ========== */
document.getElementById('retryBtn').addEventListener('click', ()=>{
  if(!mistakeArray.length) return;
  startRound(mistakeArray);
});
document.getElementById('restartBtn').addEventListener('click', ()=>{
  document.getElementById('inputArea').classList.remove('hidden');
  document.getElementById('quizArea').classList.add('hidden');
  document.getElementById('resultArea').classList.add('hidden');
  
  document.getElementById('sideMistakePanel').classList.add('hidden');
  
  document.getElementById('srcText').value = '';
  document.getElementById('srcText').focus();
});


/* ========================================= */
/* ====== â˜…è¿½åŠ â˜… æ–°æ©Ÿèƒ½é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ====== */
/* ========================================= */

document.getElementById('instantRetryBtn').addEventListener('click', ()=>{
  showQuestion();
});

document.getElementById('reviewMistakesBtn').addEventListener('click', ()=>{
    if (mistakeArray.length === 0 && !isReviewing) {
        alert("å¾©ç¿’ã™ã‚‹é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }

    if (isReviewing) {
        alert("å¾©ç¿’ã‚’ä¸­æ–­ã—ã€å…ƒã®ã‚¯ã‚¤ã‚ºã«æˆ»ã‚Šã¾ã™ã€‚");
        restoreQuizState();
        showQuestion();
    } else {
        startReviewSession();
    }
});

function startReviewSession() {
    isReviewing = true;
    backupState = {
        round: currentRound,
        index: currentIdx,
        correctCount: correctCount,
    };
    
    currentRound = [...mistakeArray];
    currentRound.forEach(q => {
        q.isMistakenOnce = false;
        delete q.userAnswerHTML;
        delete q.correctAnswerHTML;
    });
    shuffle(currentRound);
    currentIdx = 0;
    
    const reviewBtn = document.getElementById('reviewMistakesBtn');
    reviewBtn.textContent = "å¾©ç¿’ã‚’ä¸­æ–­";
    reviewBtn.classList.add('in-review');
    document.getElementById('instantRetryBtn').classList.add('hidden');
    
    updateSideMistakePanel();

    showQuestion();
}

function restoreQuizState() {
    if (!backupState) return;

    currentRound = backupState.round;
    currentIdx = backup-State.index;
    correctCount = backupState.correctCount;
    backupState = null;
    isReviewing = false;
    
    const reviewBtn = document.getElementById('reviewMistakesBtn');
    reviewBtn.textContent = "é–“é•ã„ã‚’å¾©ç¿’";
    reviewBtn.classList.remove('in-review');
    
    updateSideMistakePanel();
}

</script>
</body>
</html>
